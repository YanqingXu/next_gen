# NextGen 游戏服务器框架

这是对原有游戏服务器框架的现代化优化版本。该项目旨在保持与原框架的兼容性，同时引入现代C++特性、更好的架构设计和更高的性能。

## 优化目标

1. **降低耦合性**：重新设计服务和模块间的交互方式，降低组件间的耦合
2. **提高扩展性**：采用更灵活的插件式架构，便于添加新功能
3. **提升性能**：优化消息处理和网络IO，提高服务器性能
4. **增强可测试性**：设计便于单元测试和集成测试的架构
5. **改进开发体验**：提供更直观的API和更好的开发工具
6. **增强监控能力**：内置性能监控和问题诊断功能
7. **支持容器化部署**：设计适合云原生环境的架构

## 优化路线图

### 阶段一：基础架构重构 [已完成]
- 设计新的核心接口
- 实现现代化的消息系统
- 设计插件式模块架构
- 实现错误处理系统
- 实现日志系统
- 实现配置系统

### 阶段二：核心组件实现 [已完成]
- 实现新的网络层
  - TCP服务和会话管理
  - UDP服务和会话管理
  - 统一的ASIO封装
- 实现高性能消息队列
  - 无锁消息队列实现
  - 消息优先级支持
- 实现改进的定时器系统
  - 高性能计时器管理
  - 计时器分组功能
- 实现服务基类
  - 服务生命周期管理
  - 消息处理系统
  - 模块管理功能
- 实现模块基类
  - 模块依赖管理
  - 模块事件系统
  - 模块热更新支持

### 阶段三：功能模块迁移 [计划中]

#### 1. 兼容层设计与实现（第1个月）

- **消息兼容层**
  - 实现旧消息格式到新消息系统的转换适配器
  - 支持旧消息的序列化/反序列化
  - 实现消息类别和ID映射机制

- **服务兼容层**
  - 开发旧服务到新服务基类的适配器
  - 提供旧服务生命周期到新服务生命周期的映射
  - 支持旧服务中的事件和回调机制

- **数据库兼容层**
  - 实现数据库访问层的兼容接口
  - 支持现有ORM映射方式
  - 提供事务处理的兼容支持

#### 2. 核心服务迁移（第2-3个月）

- **NetService迁移**
  - 将NetService转换为使用NextGen网络组件
  - 实现客户端会话管理的迁移
  - 兼容现有的网络消息处理流程
  - 优化连接管理和心跳机制

- **LogicService迁移**
  - 将LogicService迁移到NextGen服务基类
  - 改进计时器和调度机制
  - 优化主循环和帧率控制
  - 实现游戏逻辑与网络层的解耦

- **DBService迁移**
  - 基于NextGen服务基类重构DBService
  - 优化数据库连接池和查询队列
  - 实现异步数据库操作
  - 提供数据库操作的性能监控

#### 3. 功能模块迁移（第4-6个月）

- **基础功能模块**
  - 将Player模块迁移到NextGen模块基类
  - 将Item系统迁移并优化物品管理
  - 将Skill系统迁移并改进技能实现

- **社交功能模块**
  - 迁移Guild系统，优化公会数据结构
  - 迁移Relationship模块，改进好友系统
  - 迁移Mail系统，提高邮件处理效率

- **战斗和场景模块**
  - 迁移Combat系统，改进战斗计算
  - 迁移Scene系统，优化场景管理
  - 实现更高效的AOI（感兴趣区域）算法

- **经济系统模块**
  - 迁移Trade系统，增强交易安全性
  - 迁移Shop模块，优化商店逻辑
  - 迁移Auction系统，改进拍卖机制

#### 4. 跨服务器功能迁移（第7-8个月）

- **跨服务器通信**
  - 设计改进的跨服务器通信协议
  - 实现基于NextGen网络层的跨服连接
  - 优化跨服数据同步机制

- **中心服务器功能**
  - 迁移centerserver核心功能
  - 优化中心服务器的负载均衡
  - 实现更高效的服务器发现机制

- **跨服玩法**
  - 迁移Cross模块功能
  - 优化跨服战斗和匹配算法
  - 改进跨服数据一致性保障

#### 5. 测试与优化（贯穿整个过程）

- **单元测试**
  - 为所有迁移的模块编写单元测试
  - 建立自动化测试流程
  - 实现模块间集成测试

- **性能测试**
  - 设计压力测试方案
  - 进行性能基准测试比较
  - 识别和解决性能瓶颈

- **稳定性测试**
  - 实现长时间运行测试
  - 模拟各种故障场景
  - 验证恢复机制的有效性

#### 迁移策略与优先级

- 先迁移核心服务，再迁移基础模块，最后迁移复杂功能模块和跨服功能
- 对于简单模块，直接重构为使用NextGen框架
- 对于复杂模块，先使用兼容层包装，再逐步改造内部实现
- 建立新旧系统行为一致性的验证机制和性能监控

### 阶段四：工具和监控 [计划中]
- 实现性能监控系统
- 开发调试和测试工具
- 提供部署和运维工具

## 与原框架的兼容性

NextGen框架将提供兼容层，允许现有的模块和消息定义在新框架上运行。这使得可以逐步迁移，而不需要一次性重写所有代码。

## 技术栈

- 现代C++（C++17/20）
- 异步IO库（如Asio）
- 高性能序列化库
- 现代化日志系统
- 单元测试框架
- 容器化支持

## 已实现的组件

### 核心组件
- **配置系统**：提供基本的配置选项和平台检测
- **错误处理**：基于Result模式的错误处理系统
- **日志系统**：支持多级别、多输出目标的日志系统
- **服务基类**：提供服务生命周期管理和消息处理功能
- **模块基类**：提供模块注册和生命周期管理

### 消息系统
- **消息基类**：定义消息的基本结构和行为
- **消息工厂**：用于创建和管理消息实例
- **消息队列**：高性能的消息传递系统
  - 无锁消息队列实现
  - 支持优先级和超时机制
- **消息处理器**：处理特定类型消息的接口

### 网络组件
- **网络服务**：处理网络连接和通信的基类
- **TCP服务**：处理TCP连接和会话管理
- **UDP服务**：处理UDP通信和数据报管理
- **会话管理**：管理客户端连接会话

### 工具类
- **定时器系统**：高精度、低开销的定时器实现
  - 支持一次性和重复计时器
  - 支持计时器分组和批量管理

## 示例
在 `examples` 目录中提供了使用框架的示例代码：
- **basic_service_example.cpp**：展示如何创建和使用基本服务和模块
- **message_queue_example.cpp**：演示消息队列的使用方法
- **timer_example.cpp**：展示定时器系统的用法

## 更新日志

### 2025-03-16
- 完成了阶段二的所有目标
- 实现了UDP服务和会话管理
- 完善了服务基类和模块基类
- 添加了模块依赖管理和热更新支持
- 实现了无锁消息队列和高性能计时器系统
- 制定了阶段三的详细实施计划
